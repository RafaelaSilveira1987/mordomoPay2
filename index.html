<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MordomoPay - Gest√£o Crist√£ Inteligente</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ================= RESET / VARI√ÅVEIS ================= */
*{margin:0;padding:0;box-sizing:border-box}
:root{
--primary:#2563eb;--success:#16a34a;--danger:#dc2626;
--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;
}
body{
font-family:Inter,system-ui;
background:linear-gradient(135deg,#667eea,#764ba2);
min-height:100vh;
}
.hidden{display:none!important}

/* ================= COMPONENTES ================= */
.loader{
position:fixed;inset:0;background:rgba(0,0,0,.7);
display:flex;align-items:center;justify-content:center;z-index:9999
}
.spinner{
width:50px;height:50px;border:4px solid #fff5;
border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

.toast{
position:fixed;top:20px;right:20px;
background:#fff;padding:14px 20px;border-radius:8px;
box-shadow:0 10px 25px #0002;z-index:9999
}
.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--danger)}

.btn{
padding:10px 18px;border:none;border-radius:8px;
cursor:pointer;font-weight:600
}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-block{width:100%}

/* ================= LAYOUT ================= */
.dashboard{display:flex;min-height:100vh}
.sidebar{
width:260px;background:#fff;padding:20px;box-shadow:2px 0 10px #0001
}
.nav-item{
width:100%;padding:12px;border:none;background:none;
border-radius:8px;text-align:left;cursor:pointer
}
.nav-item.active{background:var(--primary);color:#fff}
.main{
flex:1;background:var(--bg);padding:30px
}
.card{
background:#fff;border-radius:12px;padding:20px;margin-bottom:20px
}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}

/* ================= MODAL ================= */
.modal{
position:fixed;inset:0;background:#0007;
display:flex;align-items:center;justify-content:center;z-index:10000
}
.modal-card{
background:#fff;border-radius:12px;padding:20px;width:100%;max-width:400px
}
.form-group{margin-bottom:12px}
.form-group label{font-size:14px}
.form-group input,select{
width:100%;padding:8px;border:1px solid #ccc;border-radius:6px
}
</style>
</head>

<body>
<div id="loader" class="loader hidden"><div class="spinner"></div></div>
<div id="toast" class="toast hidden"></div>

<!-- ================= LOGIN ================= -->
<div id="login-page">
<div class="card" style="max-width:400px;margin:80px auto">
<h2>MordomoPay</h2><br>
<form id="login-form">
<input id="celular" placeholder="553298416669" required><br><br>
<input id="password" type="password" placeholder="Senha" required><br><br>
<button class="btn btn-primary btn-block">Entrar</button>
</form>
</div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard-page" class="hidden">
<div class="dashboard">
<aside class="sidebar">
<button class="nav-item active" data="dashboard">üìä Dashboard</button>
<button class="nav-item" data="transactions">üí≥ Transa√ß√µes</button>
<button id="logout" class="btn btn-danger btn-block" style="margin-top:20px">Sair</button>
</aside>

<main class="main">
<h2 id="title">Dashboard</h2><br>

<!-- DASH -->
<div id="dashboard-content">
<div class="card">
<h3>Resumo</h3>
<p>Entradas: <b id="in">R$0</b></p>
<p>Sa√≠das: <b id="out">R$0</b></p>
<p>Saldo: <b id="bal">R$0</b></p>
</div>
</div>

<!-- TRANSA√á√ïES -->
<div id="transactions-content" class="hidden">
<div class="card">
<div style="display:flex;justify-content:space-between">
<h3>Transa√ß√µes</h3>
<button class="btn btn-primary" onclick="openModal()">+ Nova</button>
</div>
<table>
<thead>
<tr><th>Data</th><th>Descri√ß√£o</th><th>Tipo</th><th>Valor</th><th></th></tr>
</thead>
<tbody id="tx-list"></tbody>
</table>
</div>
</div>

</main>
</div>
</div>

<!-- ================= MODAL ================= -->
<div id="modal" class="modal hidden">
<div class="modal-card">
<h3 id="modal-title">Nova Transa√ß√£o</h3><br>

<div class="form-group">
<label>Tipo</label>
<select id="tx-type">
<option value="entrada">Entrada</option>
<option value="saida">Sa√≠da</option>
</select>
</div>

<div class="form-group">
<label>Descri√ß√£o</label>
<input id="tx-desc">
</div>

<div class="form-group">
<label>Valor</label>
<input id="tx-val" type="number" step="0.01">
</div>

<div class="form-group">
<label>Data</label>
<input id="tx-date" type="date">
</div>

<button class="btn btn-primary btn-block" onclick="saveTx()">Salvar</button><br>
<button class="btn btn-block" onclick="closeModal()">Cancelar</button>
</div>
</div>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
'https://fetimotrijqyswrfoyzz.supabase.co',
'SEU_ANON_KEY'
);

let user=null,editId=null;

/* ================= UTIL ================= */
const $=id=>document.getElementById(id);
const toast=(m,t='success')=>{
const el=$('toast');el.textContent=m;el.className=`toast ${t}`;
el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3000);
}

/* ================= LOGIN ================= */
$('login-form').onsubmit=async e=>{
e.preventDefault();$('loader').classList.remove('hidden');

const {data,error}=await supabaseClient
.rpc('login_usuario',{p_celular:$('celular').value,p_senha:$('password').value});

if(error||!data?.length){toast('Login inv√°lido','error')}
else{
user=data[0];
$('login-page').classList.add('hidden');
$('dashboard-page').classList.remove('hidden');
loadTx();loadDash();
}
$('loader').classList.add('hidden');
}

/* ================= NAV ================= */
document.querySelectorAll('.nav-item').forEach(b=>{
b.onclick=()=>{
document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
b.classList.add('active');
$('dashboard-content').classList.add('hidden');
$('transactions-content').classList.add('hidden');
$(b.dataset.data+'-content').classList.remove('hidden');
$('title').textContent=b.textContent;
}
});

/* ================= CRUD ================= */
async function loadTx(){
const {data}=await supabaseClient.from('transacoes')
.select('*').eq('usuario_id',user.id).order('data',{ascending:false});
$('tx-list').innerHTML='';
data?.forEach(t=>{
$('tx-list').innerHTML+=`
<tr>
<td>${t.data}</td>
<td>${t.descricao}</td>
<td>${t.tipo}</td>
<td style="color:${t.tipo=='entrada'?'green':'red'}">
R$${t.valor.toFixed(2)}
</td>
<td>
<button onclick='edit(${JSON.stringify(t)})'>‚úèÔ∏è</button>
<button onclick='del("${t.id}")'>üóëÔ∏è</button>
</td>
</tr>`
});
}

async function saveTx(){
const payload={
usuario_id:user.id,
tipo:$('tx-type').value,
descricao:$('tx-desc').value,
valor:Number($('tx-val').value),
data:$('tx-date').value
};
editId
?await supabaseClient.from('transacoes').update(payload).eq('id',editId)
:await supabaseClient.from('transacoes').insert(payload);
closeModal();loadTx();loadDash();toast('Salvo!');
}

function edit(t){
editId=t.id;
$('tx-type').value=t.tipo;
$('tx-desc').value=t.descricao;
$('tx-val').value=t.valor;
$('tx-date').value=t.data;
openModal();
}

async function del(id){
if(confirm('Excluir?')){
await supabaseClient.from('transacoes').delete().eq('id',id);
loadTx();loadDash();toast('Exclu√≠do');
}
}

/* ================= DASH ================= */
async function loadDash(){
const {data}=await supabaseClient.from('transacoes')
.select('tipo,valor').eq('usuario_id',user.id);
let i=0,o=0;
data?.forEach(t=>t.tipo=='entrada'?i+=t.valor:o+=t.valor);
$('in').textContent=`R$${i.toFixed(2)}`;
$('out').textContent=`R$${o.toFixed(2)}`;
$('bal').textContent=`R$${(i-o).toFixed(2)}`;
}

/* ================= MODAL ================= */
function openModal(){editId=null;$('modal').classList.remove('hidden')}
function closeModal(){$('modal').classList.add('hidden')}

/* ================= LOGOUT ================= */
$('logout').onclick=()=>location.reload();
</script>
</body>
</html>
