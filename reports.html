<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - MordomoPay</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-box" style="background: transparent;"><img src="images/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;"></div>
                    <div class="logo-text">
                        <h1>MordomoPay</h1>
                        <p>Gest√£o Crist√£</p>
                    </div>
                </div>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="transactions.html" class="nav-item">
                    <span>üí≥</span> Transa√ß√µes
                </a>
                <a href="goals.html" class="nav-item">
                    <span>üéØ</span> Metas
                </a>
                <a href="tithe.html" class="nav-item">
                    <span>üôè</span> D√≠zimos
                </a>
                <a href="tips.html" class="nav-item">
                    <span>üí°</span> Dicas
                </a>
                <a href="reports.html" class="nav-item active">
                    <span>üìà</span> Relat√≥rios
                </a>
                <a href="#" class="nav-item" id="logout-btn" style="margin-top: auto; color: var(--destructive);">
                    <span>üö™</span> Sair
                </a>
            </nav>
            <div class="sidebar-footer">
                <p>"O que o s√°bio acumula com a m√£o √© melhor que o que o tolo desperdi√ßa."</p>
                <span>Prov√©rbios 10:14</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <div class="header-left">
                    <button id="menu-toggle" class="btn btn-ghost md-hidden">‚ò∞</button>
                    <h2 class="md-visible">Relat√≥rios Financeiros</h2>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <p class="user-name">Usu√°rio</p>
                        <p class="user-status">Conectado</p>
                    </div>
                    <div class="user-avatar">U</div>
                </div>
            </header>

            <div class="content-area">
                <div class="mb-8">
                    <h1 class="serif">Relat√≥rios</h1>
                    <p class="text-muted-foreground">An√°lise detalhada da sua mordomia financeira</p>
                </div>

                <div class="grid-3" style="grid-template-columns: 2fr 1fr;">
                    <div class="card">
                        <h3 class="serif mb-4">Fluxo de Caixa (Mensal)</h3>
                        <canvas id="cashflow-chart" height="200"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="serif mb-4">Gastos por Categoria</h3>
                        <canvas id="category-chart" height="300"></canvas>
                    </div>
                </div>

                <div class="card mt-8">
                    <h3 class="serif mb-4">Resumo por M√™s</h3>
                    <div class="table-container">
                        <table id="monthly-summary-table">
                            <thead>
                                <tr>
                                    <th>M√™s</th>
                                    <th>Receitas</th>
                                    <th>Despesas</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados reais ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await Auth.getUser();
            if (!user) return;

            // Buscar todas as transa√ß√µes do usu√°rio
            const { data: transactions, error } = await supabaseClient
                .from('transacoes')
                .select('*, categoria_trasacoes(descricao)')
                .eq('usuario_id', user.id);

            if (error) {
                console.error('Erro ao buscar dados para relat√≥rios:', error);
                return;
            }

            processAndRenderCharts(transactions);
            renderMonthlyTable(transactions);
        });

        function processAndRenderCharts(transactions) {
            const months = {};
            const categories = {};

            transactions.forEach(t => {
                const valor = parseFloat(t.valor);
                const mes = t.mes || new Date(t.data).toLocaleString('pt-BR', { month: 'long' });
                
                // Processar meses
                if (!months[mes]) months[mes] = { in: 0, out: 0 };
                if (t.tipo === 'entrada') months[mes].in += valor;
                else months[mes].out += valor;

                // Processar categorias (apenas sa√≠das)
                if (t.tipo === 'saida') {
                    const cat = t.categoria_trasacoes ? t.categoria_trasacoes.descricao : 'Outros';
                    categories[cat] = (categories[cat] || 0) + valor;
                }
            });

            // Renderizar Gr√°fico de Fluxo de Caixa
            const monthLabels = Object.keys(months);
            const inData = monthLabels.map(m => months[m].in);
            const outData = monthLabels.map(m => months[m].out);

            new Chart(document.getElementById('cashflow-chart'), {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [
                        { label: 'Receitas', data: inData, backgroundColor: '#2A4B8D' },
                        { label: 'Despesas', data: outData, backgroundColor: '#ef4444' }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Renderizar Gr√°fico de Categorias
            new Chart(document.getElementById('category-chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#2A4B8D', '#D4AF37', '#556B2F', '#1A2F5A', '#71717a', '#ef4444']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderMonthlyTable(transactions) {
            const summary = {};
            transactions.forEach(t => {
                const mes = t.mes || new Date(t.data).toLocaleString('pt-BR', { month: 'long' });
                if (!summary[mes]) summary[mes] = { in: 0, out: 0 };
                if (t.tipo === 'entrada') summary[mes].in += parseFloat(t.valor);
                else summary[mes].out += parseFloat(t.valor);
            });

            const tbody = document.querySelector('#monthly-summary-table tbody');
            tbody.innerHTML = Object.keys(summary).map(mes => {
                const s = summary[mes];
                const saldo = s.in - s.out;
                return `
                    <tr>
                        <td>${mes.charAt(0).toUpperCase() + mes.slice(1)}</td>
                        <td class="text-green">R$ ${s.in.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td class="text-red">R$ ${s.out.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td style="font-weight: bold;" class="${saldo >= 0 ? 'text-green' : 'text-red'}">
                            R$ ${saldo.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                        </td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
